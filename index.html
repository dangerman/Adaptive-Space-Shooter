<html>
<head>
Game
</br>
<body>
<p>Use arrow keys or mouse to move and click or press space to shoot
</p>
<canvas id = "myCanvas" width="900" height="450" tabindex="1">
<!-- Need to set the tab index so it gets keyboard inputs -->
</canvas>
<p id = "scores">
</p>
<p id = "stats">
</p>
<p id = "status">
</p>
<script type="text/javascript">
//Remove curosr
document.getElementById("myCanvas").style.cursor = "none";
//Set up audio
maxchannels = 10; // Allows multiple sounds to be played in parallel
channels = new Array();
for (var i=0;i<maxchannels;i++) {
	channels[i]= new Array();
	channels[i]['channel'] = new Audio();
	channels[i]['finished'] = -1;
}
function playSound(sound) {
	for (var i=0;i<channels.length;i++) {
		date = new Date();
		if (channels[i]['finished'] < date.getTime()) { //if channel finished
			channels[i]['finished'] = date.getTime() + document.getElementById(sound).duration*1000
			channels[i]['channel'].src = document.getElementById(sound).src;
			channels[i]['channel'].load();
			channels[i]['channel'].play();
		}
	}
}
//Set up images
var playerImg = new Image();
playerImg.src = "PlayerShip.png";
var playerImg2 = new Image();
var bulletImg = new Image();
bulletImg.src = "Bullet.png";
var enemyBulletImg = new Image();
enemyBulletImg.src = "EnemyBullet.png";
var enemyImg1 = new Image();
enemyImg1.src = "EasyEnemy.png";
var enemyImg2 = new Image();
enemyImg2.src = "MediumEnemy.png";
var enemyImg3 = new Image();
enemyImg3.src = "HardEnemy.png";
var pickUp1 = new Image();
pickUp1.src = "Life.png";
var pickUpCue1 = new Image();
pickUpCue1.src = "PickUp.png";
var portalImg = new Image();
portalImg.src = "Portal.png";
//Initialise game variables
var running = true;
var starCount = 50; //number of stars
var size = 10; //Size of particle
var gametime = 0;
var score = 0;
var energy = 50;
var levelNo = 0; //0th level is menu
var levelKills = 0;
var levelComplete = false;
var levelFailed = false;
var inMenu = true;
var missedPowerups = 0;

//Adaptive variables
var particleSpeed = 0.5;
var targetSpeed;
var targetHP;
var spawnInterval = 50; //how often to spawn enemies
var powerupInterval = 120; //how often to give powerups
var enemyBulletFreq = 30;
var levelKillThreshold = 2; //Kills needed to pass to next level

//Storing stats
hits = new Object();
hits.particle1 = 0;
misses = new Object();
misses.particle1 = 0;
var bulletHits = 0;
var bulletMisses = 0;

//Lists of things
var stars = new Array();
var particles = new Array();
var targets = new Array();
var bullets = new Array();
var powerups = new Array();

//Objects
function Star(x) {
	this.x = x;
	this.y = Math.random()*canvas.height;
	this.xvel = 5+Math.random()*5;
	this.size = Math.random()*3;
}
function Particle(x,y,xvel,yvel,type) { //Basic enemies - kill player upon contact, destroyed by bullets
	this.x = x;
	this.y = y;
	this.xvel = xvel;
	this.yvel = yvel;
	this.time = 0; //Time since particle spawned
	this.type = type;
	this.bulletSpawn = bulletSpawn;
}
function bulletSpawn() {
	particles.push(new Particle(this.x,this.y, -20,0,3));
}
function Bullet(x,y,type) { //Bullets fired by player
	this.x = x;
	this.y = y;
	this.type = type;
}
function Player() {
	this.x = 0;
	this.y = 0;
	this.hp = 100;
	this.goingDown = false;
	this.goingUp = false;
	this.goingRight = false;
	this.goingLeft = false;
	this.powerup = 0;
	this.powerupTime = 0;
}
function Powerup(x,y,type) {
	this.x = x;
	this.y = y;
	this.type = type;
	this.time = 600;
}
player = new Player();
//Set up canvas and stuff so we can draw
var canvas = document.getElementById("myCanvas");
var context = canvas.getContext("2d");
context.strokeStyle = "blue"; //wtf?
context.fillStyle="black";
canvas.onmousemove = getPosition;
//Portal object
portal = new Object();
portal.x = canvas.width-150;
portal.y = canvas.height/2;
portal.on = false;
//Set up inputs
canvas.addEventListener("click", shoot, false);
canvas.addEventListener("keydown",keyPressed,false);
canvas.addEventListener("keyup",keyUp,false);

function keyPressed(e) {
	console.log("key pressed");
	if (e.keyCode==37) {
		player.goingLeft = true;
	}
	if (e.keyCode==38) {
		player.goingUp = true;
	}
	if (e.keyCode==39) {
		player.goingRight = true;
	}
	if (e.keyCode==40) {
		player.goingDown = true;
	}
	if (e.keyCode==32) { //Space bar
		if (inMenu) {
			inMenu = false;
			//save high scores
			//update Player model
			//generate level variables
			levelNo++;
			document.getElementById("status").innerHTML="Level: "+levelNo+"</br>Enemy speed: "+particleSpeed;
			levelKills = 0;
			levelComplete = false;
			portal.on = false;
			energy = 50; //Need to rest energy for next level
			score = 0; ///Reset score for next level
			missedPowerups = 0;
		} else {
			shoot();
		}
	}
}
function keyUp(e) {
	if (e.keyCode==37) {
		player.goingLeft = false;
	}
	if (e.keyCode==38) {
		player.goingUp = false;
	}
	if (e.keyCode==39) {
		player.goingRight = false;
	}
	if (e.keyCode==40) {
		player.goingDown = false;
	}
}

function makeParticle(isBullet, enemy) {
	var rand = Math.random();
	if (rand > 0.66) {
		particles.push(new Particle(canvas.width,Math.random()*canvas.height, -(5+(Math.random()*6)),0,0));
	} else if (rand > 0.33) {
		particles.push(new Particle(canvas.width,(canvas.height * 0.05) + Math.random()*(canvas.height*0.7), -(5+(Math.random()*6)),0,1));
	} else {
		particles.push(new Particle(canvas.width,(canvas.height * 0.05) + Math.random()*(canvas.height*0.5), -(5+(Math.random()*6)),0,2));
	}
}
function makePowerup() {
	powerups.push(new Powerup(Math.random()*canvas.width,20+(Math.random()*(canvas.height-20)),0));
}
function makeStar() {
	stars.push(new Star(canvas.width));
}
function makeTarget() {
	targets.push(new Target(canvas.width, Math.random()*canvas.height));
}

function shoot(e) { //Called when player clicks
	var x = player.x+74;
	var y = player.y+36;
	//console.log("shoot! ",x," ",y);
	if (!inMenu)
		bullets.push(new Bullet(x, y,1));
}

var t = setInterval("update()", 1000/60); //Essentially sets framerate

//Set up stars
for (var i=0;i<starCount;i++) {
	stars.push(new Star(Math.random()*canvas.width));
}

function draw() {
	//Draw background
	context.fillStyle = "rgba(20,20,20,0.4)";
	context.fillRect(0,0,canvas.width, canvas.height);
	//Draw stars
	for (var i=0;i<stars.length;i++) {
		context.fillStyle="white";
		context.beginPath();
		context.arc(stars[i].x,stars[i].y,stars[i].size,0, Math.PI*2, true);
		context.closePath();
		context.fill();
	}
	//Draw targets
	for (var i=0;i<targets.length;i++) {
		//colour = "darkcyan";
		colour = "rgba("+(255-(i*32))+",128,"+(i*32)+", "+(1-(targets[i].hits*0.1))+")";
		context.fillStyle=colour;
		//context.fillRect(targets[i].x-(canvas.width/8), 0, canvas.width/4, 10);
		context.fillRect(targets[i].x-75, 0, 150, 10);
	}
	//Draw particles
	var size;
	for (var i =0; i< particles.length;i++) {
		//colour = "rgba("+String(particles[i].time%300)+",0,0,0.5)";
		if (particles[i].type==1) {
			context.drawImage(enemyImg1, particles[i].x-36, particles[i].y-24,87,37.5);
		}
		else if (particles[i].type==0) {
			context.drawImage(enemyImg2, particles[i].x-36, particles[i].y-24,94,48);
		}
		else if (particles[i].type==2) {
			context.drawImage(enemyImg3, particles[i].x-36, particles[i].y-24,193,68);
		}
		else if (particles[i].type==3) {
			context.drawImage(enemyBulletImg, particles[i].x, particles[i].y,50,30);
		}
		//colour = "Darkorange";
		//context.fillStyle=colour;
		//context.beginPath();
		//context.arc(particles[i].x,particles[i].y, 24, 0, Math.PI*2, true); //size should change over time
		//context.closePath();
		//context.fill();
	}
	//Draw player
	//context.fillStyle="red";
	context.drawImage(playerImg, player.x, player.y-10,88,62);
	//context.fillRect(player.x,player.y,88,40);
	//Draw Bullets
	for (var i=0;i<bullets.length;i++) {
		context.drawImage(bulletImg, bullets[i].x, bullets[i].y-15,50,30);
	      //context.fillStyle="purple";
	      //context.beginPath();
	      //context.arc(bullets[i].x,bullets[i].y, 6, 0, Math.PI*2, true);
	      //context.closePath();
	      //context.fill();
	}
	//Draw powerups
	for (var i=0; i<powerups.length;i++) {
		//context.fillStyle="green";
		//context.fillRect(powerups[i].x, powerups[i].y, 20,20);
		if (powerups[i].type==0) {
			
			//console.log(powerups[i].time);
			context.globalAlpha = (powerups[i].time / 600);
			context.drawImage(pickUp1, powerups[i].x, powerups[i].y,29,25);
			context.globalAlpha = 1;
			if (powerups[i].time < 301 && missedPowerups > 2) {
			    context.globalAlpha = 1 - (powerups[i].time / 300);
			    context.drawImage(pickUpCue1, powerups[i].x - 15, powerups[i].y - 20,57,8);
			    context.globalAlpha = 1;
				console.log("pickupcue displayed");
			}
		}         
	}
	//Draw portal
	if (portal.on) {
		context.drawImage(portalImg, portal.x, portal.y);
	}
	//Print scores
	document.getElementById("scores").innerHTML="Score:\t"+score+"\nEnergy:\t"+energy;
	if (energy<=0) {
		inMenu = true;
		document.getElementById("scores").innerHTML="High score: "+score+"\tRefresh page to try again!";
	}
}

function update() {
	draw();
	if (inMenu) {
		context.fillStyle="rgba(0,0,0,0.5)"; //Darken background
		context.fillRect(0,0,canvas.width, canvas.height);
		context.fillStyle="rgba(128,128,128,0.8)";
		context.fillRect(0,canvas.height/3,canvas.width, canvas.height/3);
		context.fillStyle="black";
		context.font="50px sans-serif";
		context.textBaseline="middle";
		if (levelNo==1) {
			context.fillText("Press Space to start",canvas.width/9, canvas.height/2);
		} else if (levelComplete){
			context.fillText("Level complete!",canvas.width/4, canvas.height/2);
		} else {
			context.fillText("You died D:",canvas.width/4, canvas.height/2);
		}
	}
	else {
		gametime++; //Update time
		//Make new enemies
		if (gametime%spawnInterval==0) {
			makeParticle();
		}
		
		//Make new powerups
		if (gametime%powerupInterval==0) {
			if (Math.random()<0.5) { //50% chance of powerup
				makePowerup();
			}
		}
		if (levelKills>=levelKillThreshold) {
			//Create portal
			portal.on = true;
		}
		var remove = false; //Not sure this line is needed...
		//Move the player for keyboard input
		if (player.goingUp) {
			player.y -= 6;
		}
		if (player.goingDown) {
			player.y += 6;
		}
		if (player.goingLeft) {
			player.x -= 6;
		}
		if (player.goingRight) {
			player.x += 6;
		}
		
		//Keep player within bounds of canvas
		if (player.x<0) {player.x=0;}
		if (player.x>canvas.width) {player.x=canvas.width;}
		if (player.y<0) {player.y=0;}
		if (player.y>canvas.height) {player.y=canvas.height;}
		
		//Stars
		for (var i=0;i<stars.length;i++) {
			stars[i].x -= stars[i].xvel;
			if (stars[i].x < 0) {
				stars.splice(i,1);
				makeStar();
			}
		}
		//Check for collisions with powerups
		for (var j=0;j<powerups.length;j++) {
			powerups[j].time--;
			
			if (powerups[j].time < 1) {
			    powerups.splice(j, 1);
			    missedPowerups++;
			}
			
			if (powerups[j])
			{
			    if (boxCollision(player.x, player.y, 45,62, powerups[j].x-30, powerups[j].y+15,20,20)) {
				    powerups.splice(j,1);
				    energy+=10;
			    }
			}
			
		}
		//Particles
		for (var i=0;i<particles.length;i++) {
			remove = false;
			if (particles[i].type==0) { //Move type 0 particles -> horizontal
				particles[i].x += (particles[i].xvel*particleSpeed);
				particles[i].y += (particles[i].yvel*particleSpeed);
			}
			if (particles[i].type==1) { //Move type 1 particles ->
				particles[i].x += (particles[i].xvel*particleSpeed);
				particles[i].y += (Math.sin(particles[i].time/10)*10*particleSpeed);
			}
			if (particles[i].type==2) { //Move type 2 particles ->
				particles[i].x += ((particles[i].xvel*particleSpeed)/2);
				particles[i].y += (Math.sin(particles[i].time/40)*5*particleSpeed);
				if (particles[i].time % 30 == 0)
				{
					particles[i].bulletSpawn();
				}
			}
			if (particles[i].type==3) { //Move type 2 particles ->
				particles[i].x += (particles[i].xvel*particleSpeed);
			}
			particles[i].time++;
			//remove offscreen particles
			if (particles[i].x>canvas.width) {
				remove = true;
			}
			else if (particles[i].x<0) { //Player has missed enemy
				remove = true;
				misses.particle1++;
				updateStats();
			}
			if (particles[i].y<0) { //Not sure this bit is needed at all
				for (var j=0;j<targets.length;j++) {
					if (particles[i].x<targets[j].x+(canvas.width/8) && particles[i].x>targets[j].x-(canvas.width/8)) {
						score++;
						energy++;
						targets[j].hits++;
						console.log("Hit!");
						break;
					}
				}
				remove = true;
			}
			
			//Check for collisions with bullets
			for (var j=0;j<bullets.length;j++) {
				if (particles[i].type == 1) {
					if (boxCollision(particles[i].x+5,particles[i].y-25,82,43,bullets[j].x-3,bullets[j].y-3,12,12)) {
						bullets.splice(j,1);
						remove=true;
						score += 100;
						hits.particle1++;
						bulletHits++;
						updateStats();
						levelKills++;
					}
				}
				else if (particles[i].type == 0) {
					if (boxCollision(particles[i].x+5,particles[i].y-20,94,48,bullets[j].x-3,bullets[j].y-3,12,12)) {
						bullets.splice(j,1);
						remove=true;
						score += 100;
						hits.particle1++;
						bulletHits++;
						updateStats();
						levelKills++;
					}
				}
				else if (particles[i].type == 2) {
					if (boxCollision(particles[i].x+110,particles[i].y-10,193,40,bullets[j].x-3,bullets[j].y-3,12,12)) {
						bullets.splice(j,1);
						remove=true;
						score += 100;
						hits.particle1++;
						bulletHits++;
						updateStats();
						levelKills++;
					}
				}
			}
			//Collision with player
			if (particles[i].type == 1) {
			    //context.fillRect(particles[i].x-25,particles[i].y-25,82,43);
			    if (boxCollision(player.x+45,player.y+5,110,25,particles[i].x-25,particles[i].y-25,82,43)) {
				    energy=0;
			    }
			}
			else if (particles[i].type == 0) {
			    //context.fillRect(particles[i].x-30,particles[i].y-23,94,48);
			    if (boxCollision(player.x+45,player.y+5,110,45,particles[i].x-30,particles[i].y-20,94,48)) {
				    energy=0;
			    }
			}
			else if (particles[i].type == 2) {
			    //context.fillRect(particles[i].x-30,particles[i].y-20,185,35);
			    if (boxCollision(player.x+45,player.y+5,170,25,particles[i].x-15,particles[i].y-30,193,68)) {
				    energy=0;
			    }
			}
			else if (particles[i].type == 3) {
			    //context.fillRect(particles[i].x-30,particles[i].y-20,185,35);
			    if (boxCollision(player.x+10,player.y-15,88,50,particles[i].x-3,particles[i].y-3,12,12)) {
				    energy=0;
			    }
			}
			if (remove) {particles.splice(i,1); energy--;}
		}
		//Bullets
		for (var i=0;i<bullets.length;i++) {
			  remove = false;
			  if (bullets[i].type==1) {
				bullets[i].x += 20;
			  }
			  if (bullets[i].x>canvas.width) {
				remove = true;
				bulletMisses++;
				updateStats();
				}
			  if (remove) {
				bullets.splice(i,1);
			  }
		}
		//Collisions with portal
		if (boxCollision(player.x+45,player.y+5,88,50,portal.x+5,portal.y+5,100,150)) {
			levelComplete = true;
			inMenu = true;
		}
		//if (energy<0) {running=false;}
	}
}

function getPosition(e) {
	var x;
	var y;
	if (e.pageX || e.pageY) { //pageX and pageY are relative to the window
		x = e.pageX;
		y = e.pageY;
	} else { //sort out offsets and stuff
		x = e.clientX+document.body.scrollLeft + document.documentElement.scrollLeft;
		y = e.clientY+document.body.scrollTop + document.documentElement.scrollTop;
	}
	x -=canvas.offsetLeft;
	y -= canvas.offsetTop;
	player.x=x-44;
	player.y=y-30;
	return [x,y];
}

function boxCollision(x,y,w,h,x2,y2,w2,h2 ) { //Top left, width, height corners of boxes
	if ((x < x2+w) && (x+h>x2) && (y<y2+h2) && (y+h>y2)) {
		return true;
	}
	else {return false;}
}

function updateStats() {
	document.getElementById("stats").innerHTML="Hits: "+hits.particle1+"</br> Missesed enemies: "+misses.particle1+"</br>Overall Accuracy: "+(bulletHits/bulletHits+bulletMisses);
}

</script>
</body>
</head>
</html>
